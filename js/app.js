var connectionsObject = {
  "connections": [
    {
      "from": {
        "station": {
          "id": "8504221",
          "name": "Neuchâtel",
        },
        "departure": "2017-05-17T05:04:00+0200",
        "departureTimestamp": 1494990240,
        "platform": "2",
      },
      "to": {
        "station": {
          "id": "8507100",
          "name": "Thun",
        },
        "arrival": "2017-05-17T06:22:00+0200",
        "arrivalTimestamp": 1494994920,
        "platform": "1",
      },
      "duration": "00d01:18:00",
      "transfers": 1,
      "sections": [
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8504221",
              "name": "Neuchâtel",
            },
            "departure": "2017-05-17T05:04:00+0200",
            "departureTimestamp": 1494990240,
            "platform": "2",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T05:52:00+0200",
            "arrivalTimestamp": 1494993120,
            "platform": "13",
          }
        },
        {
          "walk": {
            "duration": "00:12:00"
          },
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T05:52:00+0200",
            "departureTimestamp": 1494993120,
            "platform": "",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T06:04:00+0200",
            "arrivalTimestamp": 1494993840,
            "platform": "",
          }
        },
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T06:04:00+0200",
            "departureTimestamp": 1494993840,
            "platform": "2",
          },
          "arrival": {
            "station": {
              "id": "8507100",
              "name": "Thun",
            },
            "arrival": "2017-05-17T06:22:00+0200",
            "arrivalTimestamp": 1494994920,
            "platform": "1",
          }
        }
      ]
    },
    {
      "from": {
        "station": {
          "id": "8504221",
          "name": "Neuchâtel",
        },
        "departure": "2017-05-17T05:36:00+0200",
        "departureTimestamp": 1494992160,
        "platform": "1B",
      },
      "to": {
        "station": {
          "id": "8507100",
          "name": "Thun",
        },
        "arrival": "2017-05-17T06:52:00+0200",
        "arrivalTimestamp": 1494996720,
        "platform": "1",
      },
      "duration": "00d01:16:00",
      "transfers": 1,
      "sections": [
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8504221",
              "name": "Neuchâtel",
            },
            "departure": "2017-05-17T05:36:00+0200",
            "departureTimestamp": 1494992160,
            "platform": "1B",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T06:26:00+0200",
            "arrivalTimestamp": 1494995160,
            "platform": "",
          }
        },
        {
          "walk": {
            "duration": "00:08:00"
          },
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T06:26:00+0200",
            "departureTimestamp": 1494995160,
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T06:34:00+0200",
            "arrivalTimestamp": 1494995640,
            "platform": "",
            "realtimeAvailability": "RT_BHF",
          }
        },
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T06:34:00+0200",
            "departureTimestamp": 1494995640,
            "platform": "6",
          },
          "arrival": {
            "station": {
              "id": "8507100",
              "name": "Thun",
            },
            "arrival": "2017-05-17T06:52:00+0200",
            "arrivalTimestamp": 1494996720,
            "platform": "1",
          }
        }
      ]
    },
    {
      "from": {
        "station": {
          "id": "8504221",
          "name": "Neuchâtel",
        },
        "departure": "2017-05-17T06:01:00+0200",
        "departureTimestamp": 1494993660,
        "platform": "1",
      },
      "to": {
        "station": {
          "id": "8507100",
          "name": "Thun",
        },
        "arrival": "2017-05-17T07:22:00+0200",
        "arrivalTimestamp": 1494998520,
        "platform": "1",
      },
      "duration": "00d01:21:00",
      "transfers": 1,
      "sections": [
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8504221",
              "name": "Neuchâtel",
            },
            "departure": "2017-05-17T06:01:00+0200",
            "departureTimestamp": 1494993660,
            "platform": "1",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T06:52:00+0200",
            "arrivalTimestamp": 1494996720,
            "platform": "13C",
          }
        },
        {
          "walk": {
            "duration": "00:12:00"
          },
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T06:52:00+0200",
            "departureTimestamp": 1494996720,
            "platform": "",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T07:04:00+0200",
            "arrivalTimestamp": 1494997440,
            "platform": "",
          }
        },
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T07:04:00+0200",
            "departureTimestamp": 1494997440,
            "platform": "4",
          },
          "arrival": {
            "station": {
              "id": "8507100",
              "name": "Thun",
            },
            "arrival": "2017-05-17T07:22:00+0200",
            "arrivalTimestamp": 1494998520,
            "platform": "1",
          }
        }
      ]
    },
    {
      "from": {
        "station": {
          "id": "8504221",
          "name": "Neuchâtel",
        },
        "departure": "2017-05-17T06:33:00+0200",
        "departureTimestamp": 1494995580,
        "platform": "4",
      },
      "to": {
        "station": {
          "id": "8507100",
          "name": "Thun",
        },
        "arrival": "2017-05-17T07:46:00+0200",
        "arrivalTimestamp": 1494999960,
        "platform": "4",
      },
      "duration": "00d01:13:00",
      "transfers": 1,
      "sections": [
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8504221",
              "name": "Neuchâtel",
            },
            "departure": "2017-05-17T06:33:00+0200",
            "departureTimestamp": 1494995580,
            "platform": "4",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T07:07:00+0200",
            "arrivalTimestamp": 1494997620,
            "platform": "13",
            "realtimeAvailability": "RT_BHF",
          }
        },
        {
          "walk": {
            "duration": "00:09:00"
          },
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T07:07:00+0200",
            "departureTimestamp": 1494997620,
            "platform": "",
          },
          "arrival": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "arrival": "2017-05-17T07:16:00+0200",
            "arrivalTimestamp": 1494998160,
            "platform": "",
          }
        },
        {
          "walk": null,
          "departure": {
            "station": {
              "id": "8507000",
              "name": "Bern",
            },
            "departure": "2017-05-17T07:16:00+0200",
            "departureTimestamp": 1494998160,
            "platform": "8",
          },
          "arrival": {
            "station": {
              "id": "8507100",
              "name": "Thun",
            },
            "arrival": "2017-05-17T07:46:00+0200",
            "arrivalTimestamp": 1494999960,
            "platform": "4",
          }
        }
      ]
    }
  ],
  "from": {
    "id": "008504221",
    "name": "Neuchâtel",
  },
  "to": {
    "id": "008507100",
    "name": "Thun",
  },
}


$(document).ready(function() {

  // For Materialize Select form elements
  $('select').material_select();

  // To make a hamburger menu for small screens
  $(".button-collapse").sideNav();

  // Search button. Event listener and handler.
  $('#search-button').click((event) => {
    event.preventDefault(); // so <a href="#"> does not scroll

    // Get form data
    let fromStation = $('#from-station')[0].value;
    let endStation = $('#to-station')[0].value;

    // Hit the API
    // getStationIds(fromStation, endStation)
    // .then(getConnections)
    // .then(displayResults)
    // .catch(catchError);

    // Hit fake but super-fast local "API" (Object above)
    displayResults(connectionsObject);
  });

});


function getStationIds(fromStationName, endStationName) {
  const baseURL = 'http://transport.opendata.ch/v1/locations?type=station&query=';
  let fromStation = getJsonFromFetch(baseURL + fromStationName);
  let endStation = getJsonFromFetch(baseURL + endStationName);
  return Promise.all([fromStation, endStation]);
}


function getConnections(stations) {
  let stationIds = stations.map(stationObj => stationObj.stations[0].id);
  let connURL = connectionsURL(...stationIds);
  return getJsonFromFetch(connURL)
}


function displayResults(connectionsObject) {
  console.log(connectionsObject);

  let coob = connectionsObject; // shorter name
  let fr = coob.from.name;
  let to = coob.to.name;
  let txt = `Here are your choices for train departure times from ${fr} to ${to}:`;
  $('#from-and-to').text(txt);

  for (let i = 0; i < coob.connections.length; i++) {
    // Add to results table
    let [depDate, depTime] = chopUpTime(coob.connections[i].from.departure);
    let [arrDate, arrTime] = chopUpTime(coob.connections[i].to.arrival);
    let tr = $('<tr>');
    tr.append($('<td>').text(depDate));
    tr.append($('<td>').text(depTime));
    tr.append($('<td>').text(arrTime));
    $('#table-of-connections tbody').append(tr);
  }

}


function chopUpTime(dateAndTimeString) {
  let pieces = dateAndTimeString.match(/(.+)T(\d+:\d+)/)
  return [pieces[1], pieces[2]];
}


function catchError(err) {
  throw new Error(err);
}


function getJsonFromFetch(url) {
  return fetch(url)
    .then(response => response.json());
}


function connectionsURL(fromStationId, endStationId) {
  return `http://transport.opendata.ch/v1/connections?from=${fromStationId}&to=${endStationId}`;
}
